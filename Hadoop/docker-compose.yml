version: "3.8"

services:
  # ğŸŒ NameNode (nodo maestro)
  namenode:
    build: .
    container_name: namenode
    hostname: namenode
    image: hadoop-custom:latest
    ports:
      - "9870:9870" # Web UI HDFS
      - "8088:8088" # Web UI YARN
      - "22:22" # SSH
      - "8020:8020" # RPC HDFS
    volumes:
      - namenode-data:/usr/local/hadoop/dfs/name
      - ./hadoop-conf:/usr/local/hadoop/etc/hadoop
    environment:
      - HADOOP_CONF_DIR=/usr/local/hadoop/etc/hadoop
    networks:
      hadoop-net:
        ipv4_address: 172.20.0.2
    command: [ "/usr/local/bin/start-hadoop.sh" ]
    tty: true

  # ğŸ’¾ DataNode 1
  datanode1:
    build: .
    container_name: datanode1
    hostname: datanode1
    image: hadoop-custom:latest
    ports:
      - "9864:9864" # Web UI DataNode
      - "9866:9866" # Data transfer
      - "9867:9867" # IPC
    volumes:
      - datanode1-data:/usr/local/hadoop/dfs/data
      - ./hadoop-conf:/usr/local/hadoop/etc/hadoop
    depends_on:
      - namenode
    networks:
      hadoop-net:
        ipv4_address: 172.20.0.3
    command: [ "/usr/local/bin/start-hadoop.sh" ]
    tty: true

  # ğŸ’¾ DataNode 2
  datanode2:
    build: .
    container_name: datanode2
    hostname: datanode2
    image: hadoop-custom:latest
    ports:
    - "9865:9864" # ğŸ”¥ CAMBIAR: 9865 externo â†’ 9864 interno
    - "9868:9866" # ğŸ”¥ CAMBIAR: 9868 externo â†’ 9866 interno
    - "9869:9867" # ğŸ”¥ CAMBIAR: 9869 externo â†’ 9867 interno
    volumes:
    - datanode2-data:/usr/local/hadoop/dfs/data
    - ./hadoop-conf:/usr/local/hadoop/etc/hadoop
    depends_on:
    - namenode
    networks:
      hadoop-net:
        ipv4_address: 172.20.0.4
    command: [ "/usr/local/bin/start-hadoop.sh" ]
    tty: true

# VolÃºmenes persistentes para los metadatos y bloques
volumes:
  namenode-data:
  datanode1-data:
  datanode2-data:

    # Red bridge compartida para la comunicaciÃ³n interna
networks:
  hadoop-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
